{% extends "base.html" %}
{% block content %}

<h3 class="fw-bold mb-4" style="background:linear-gradient(90deg,#7f5af0,#00f5ff); -webkit-background-clip:text;-webkit-text-fill-color:transparent;">üéôÔ∏è AI Voice Mock Interview (Live)</h3>

<div class="glass-card p-4 mb-4">
    <div class="card-body">

        <div class="alert alert-info">
            Click "Start Recording" and answer verbally. AI will respond in text and voice.
        </div>

        <!-- Chat Box -->
        <div class="border rounded p-3 mb-3"
             style="height:400px; overflow-y:auto; background:#f8f9fa;"
             id="chatBox">
            <div id="conversation"></div>
        </div>

        <!-- Voice Controls -->
        <div class="mb-3">
            <button onclick="startRecording()" class="btn btn-primary me-2">
                üé§ Start Recording
            </button>
            <button onclick="stopRecording()" class="btn btn-danger me-2">
                ‚èπ Stop
            </button>
            <button onclick="resetConversation()" class="btn btn-warning">
                üîÑ Restart
            </button>
        </div>

    </div>
</div>

<script>
let recognition;
let chatBox = document.getElementById("conversation");

// Load previous session messages if any
window.onload = function() {
    // Optional: fetch previous session messages from backend if you implement
    addMessage("AI", "Hello! Let‚Äôs begin your mock interview. Tell me about yourself.");
}

// Start recording
function startRecording() {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.continuous = false;

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        addMessage("You", transcript);
        sendToAI(transcript);
    };

    recognition.start();
}

// Stop recording
function stopRecording() {
    if (recognition) recognition.stop();
}

// Reset conversation
function resetConversation() {
    chatBox.innerHTML = "";
    addMessage("AI", "Hello! Let‚Äôs begin your mock interview. Tell me about yourself.");

    // Clear session on backend (optional)
    fetch("/voice-interview/reset", {method: "POST"});
}

// Add message to chat box
function addMessage(role, text) {
    const div = document.createElement("div");
    div.className = "mb-2";
    div.innerHTML = `<strong>${role}:</strong> ${text}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Send transcript to backend AI
async function sendToAI(userText) {
    const response = await fetch("/voice-interview", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({user_text: userText})
    });

    const data = await response.json();
    addMessage("AI", data.ai_reply);

    // Text-to-Speech
    const utter = new SpeechSynthesisUtterance(data.ai_reply);
    speechSynthesis.speak(utter);
}
</script>

{% endblock %}
